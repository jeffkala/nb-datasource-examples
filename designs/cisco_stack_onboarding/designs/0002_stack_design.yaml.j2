---
{% set _stack_data = get_stack_data() %}
devices:
{% for get_stack_data_instance in _stack_data %}
{%    for master, members in get_stack_data_instance.items() %}
{%        for member, member_data in members.items() %}
  - "!get:name": "{{ master }}"
      virtual_chassis__name: "{{ master }}"
      vc_priority: "{{ member_data['priority'] }}"
      vc_position: "{{ member }}"
{%        endfor %}
{%    endfor %}
{% endfor %}

virtual_chassis:
{% for get_stack_data_instance in _stack_data %}
{%    for vc_main_device, stack_members in get_stack_data_instance.items() %}
{%          if stack_members.keys() | list | count > 1 %}
- "!create_or_update:name": "{{ vc_main_device }}"
  "deferred": true
  master__name: "{{ get_current_stack_master(get_stack_data_instance) }}"
{%          endif %}
{%    endfor %}
{% endfor %}
